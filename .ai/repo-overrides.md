# vasm-ext Repository Overrides

**Project:** vasm-ext - Portable and retargetable assembler
**Language:** ANSI C90
**Last Updated:** 2026-01-08

---

## Language-Specific Rules

### C Language Requirements

**This is a C codebase, NOT C++**

All new code generated by AI must follow C-specific standards:

1. **C90 Standard Compliance**
   - Use ANSI C90 syntax only
   - No C99/C11/C++ features
   - Compilation flags: `-std=c90 -O2 -pedantic`

2. **C-Specific Patterns**
   - Use C-style memory management (`malloc`, `free`, `realloc`)
   - Use C-style error handling (return codes, errno, error flags)
   - Use C-style structs (no constructors, no member functions)
   - Use function pointers for polymorphism (not vtables)
   - Use `typedef struct` pattern for types

3. **Platform Macros**
   - Support: `-DUNIX`, `-DAMIGA`, `-DATARI`, `-DMSDOS`, `-D_WIN32`
   - Write portable code that works across all platforms

4. **Indentation**
   - **Override ai-pack C++ guidelines:** Use **2 spaces** (not 4)
   - NO TABS - Spaces only
   - This matches vasm's existing codebase style

5. **Naming Conventions**
   - Follow vasm's existing conventions:
     - `snake_case` for functions and variables
     - `UPPER_CASE` for macros and constants
     - Global functions prefixed by module (e.g., `cpu_`, `syntax_`, `output_`)

---

## Testing and Quality Requirements

### Scope: New Code Only

**CRITICAL:** TDD and code coverage requirements apply ONLY to new code we generate, not legacy vasm code.

**For NEW Code Generated by AI:**

1. **TDD Workflow (MANDATORY)**
   - Write test first
   - Implement to pass test
   - Refactor if needed
   - All tests must pass (zero tolerance for failures)

2. **Code Coverage Target**
   - 80-90% coverage for new functions/modules
   - Focus on logic paths, not legacy code

3. **Test Framework**
   - Use vasm's existing test infrastructure
   - Tests should build with standard vasm Makefile
   - Test files follow pattern: `tests/<syntax>/test_*.s` for assembly tests

**For LEGACY Code (Existing vasm):**

- **No TDD requirement** - Existing code preserved as-is
- **No coverage requirement** - Don't retroactively test old code
- **Bug fixes:** May add tests to prevent regression, but not mandatory
- **Refactoring:** Only when explicitly requested and necessary

---

## Architecture Constraints

### Module System

vasm uses a plugin architecture with three module types:

1. **CPU Modules** (`cpus/<cpu>/`)
   - Define instruction sets and addressing modes
   - Must provide: `cpu.c`, `cpu.h`, `cpu_errors.h`

2. **Syntax Modules** (`syntax/<syntax>/`)
   - Parse assembly language syntax
   - Must provide: `syntax.c`, `syntax.h`, `syntax_errors.h`

3. **Output Modules** (`output_*.c` in root)
   - Generate object file formats
   - All compiled into every executable

**When generating new code:**
- Respect module boundaries
- Follow existing interface patterns
- Add CPU/syntax modules as separate plugins, not modifications to core
- Output modules compiled into all binaries

---

## Build System

### Compilation

```bash
# Build pattern
make CPU=<cpu> SYNTAX=<syntax>

# Example
make CPU=6502 SYNTAX=merlin
make CPU=6809 SYNTAX=edtasm
```

**New code must:**
- Build with existing Makefile system
- Support all platforms (Unix, Windows, Amiga, Atari)
- Use include paths: `-I.`, `-Icpus/<CPU>`, `-Isyntax/<SYNTAX>`

---

## Documentation Requirements

### For New Features

1. **Code Comments**
   - C-style comments: `/* comment */`
   - Document complex algorithms
   - Explain non-obvious decisions
   - Reference specifications when implementing opcodes

2. **CLAUDE.md Updates**
   - Document new features in CLAUDE.md
   - Include usage examples
   - Note any architecture implications
   - Document bug fixes with root cause analysis

3. **External Documentation**
   - Update `doc/*.texi` for user-facing features
   - Not required for internal refactoring

---

## Version Control

### Commit Messages

Follow vasm's existing style:
- Concise subject line (50 chars max)
- Imperative mood: "Add feature" not "Added feature"
- Include co-author tag:
  ```
  Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>
  ```

### Git Workflow

- Work on feature branches when appropriate
- Keep commits atomic and focused
- Test before committing
- Follow existing commit patterns in `git log`

---

## Exceptions to ai-pack Standards

### Overrides to `.ai-pack/` Standards

| ai-pack Standard | vasm-ext Override | Reason |
|------------------|-------------------|--------|
| C++ guidelines apply | C90 guidelines apply | This is a C codebase |
| TDD for all code | TDD for new code only | Large legacy codebase |
| 80-90% coverage overall | 80-90% coverage for new code | Legacy code not tested |
| 4-space indent (C++) | 2-space indent (C) | Match existing vasm style |

### What Still Applies

All other ai-pack standards remain in effect:
- SOLID principles (adapted for C)
- Design principles (Tell Don't Ask, DI patterns via function pointers)
- Refactoring guidelines
- Code review checklist
- Quality gates (safety, verification, tool policy)
- Workflow processes (feature, bugfix, refactor, research)

---

## Project-Specific Patterns

### Error Handling

```c
/* Return codes pattern */
int function_name(args) {
  if (error_condition) {
    general_error(ERROR_CODE);
    return 0;  /* failure */
  }
  return 1;  /* success */
}
```

### Memory Management

```c
/* Always check allocations */
void *ptr = malloc(size);
if (!ptr) {
  general_error(OUT_OF_MEMORY);
  return;
}
/* ... use ptr ... */
free(ptr);
```

### Symbol Tables

```c
/* Use vasm's hash-based symbol tables */
symbol *sym = find_symbol(name);
if (!sym) {
  sym = add_symbol(name);
}
```

### Atoms (Core Data Structure)

```c
/* Create atoms for assembly elements */
atom *a = new_atom(type, size);
/* Add to section */
add_atom(current_section, a);
```

---

## Critical Invariants

### ✅ DO

- Write C90-compliant code
- Use 2-space indentation
- Test new code thoroughly
- Respect module boundaries
- Follow existing naming conventions
- Document complex logic
- Update CLAUDE.md for significant changes

### ❌ NEVER

- Use C++ features or syntax
- Mix tabs and spaces
- Break module interfaces
- Skip testing new code
- Commit failing tests
- Modify core without understanding multi-pass system
- Change indentation style to match ai-pack C++ defaults

---

## Contact and Questions

For vasm-specific questions:
- See `CLAUDE.md` for architecture details
- Review existing code in relevant module
- Check `doc/*.texi` for specifications

For ai-pack framework questions:
- See `.ai-pack/README.md`
- Review `.ai-pack/gates/` and `.ai-pack/roles/`

---

**Framework Version:** See `.ai-pack/VERSION`
**vasm Version:** See `vasm.c` (search for `_VER`)
